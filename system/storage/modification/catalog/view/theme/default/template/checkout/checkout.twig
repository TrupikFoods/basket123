{{ header }}

         <div id="SMSAlertCheckOTPModal" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="false" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Verification OTP</h4>
      </div>
      <div class="modal-body">
	  <div class="form-group">
        <input type="text" name="smsalert_checkout_otp_code" placeholder="Enter OTP" id="smsalert_checkout_otp_code" class="form-control" autocomplete="off" />
		</div>
			<br/>
			<button type="button" class="btn btn-default" id="smsalert_checkout_resend_btn">Resend</button>
			<span class="checkout_timer"></span>
			
			<input type="button" id="smsalert_otp_checkout_verify_button" value="Validate OTP" class="btn btn-primary pull-right" />
      </div>
    </div>

  </div>
</div>
<script type="text/javascript"><!--
var interval;
$(document).ready(function() {
	$('#button-payment-method').unbind('click').bind('click', function() {
		var pay_method=$('[name="payment_method"]:checked').val();
		var enable_pay_method = '{{enabled_payment_methods}}';
		
		if(enable_pay_method=='' || (enable_pay_method.split(',').length > 0 && enable_pay_method.split(',').indexOf(pay_method) > -1))
		{
			$(document).undelegate( '#button-payment-method', "click");
			sendOTPForCheckout();
			return false;
		}
		
		procceedCheckoutConfirm();
		
	});
	$('#smsalert_otp_checkout_verify_button').unbind('click').bind('click', function() {
		verifyOTPForCheckout();
	});
	$('#smsalert_checkout_resend_btn').unbind('click').bind('click', function() {
		sendOTPForCheckout();
		return false;
	});
});



function checkout_timerCount()
{
	var resend_checkout_timer = '{{resend_timer}}';
	var checkout_timer = function(secs){
		var sec_num = parseInt(secs, 10);
		var hours   = Math.floor(sec_num / 3600) % 24;
		var minutes = Math.floor(sec_num / 60) % 60;
		var seconds = sec_num % 60;
		hours = hours < 10 ? "0" + hours : hours;
		minutes = minutes < 10 ? "0" + minutes : minutes;
		seconds = seconds < 10 ? "0" + seconds : seconds;
		return [hours,minutes,seconds].join(":")
	};
	$(".checkout_timer").css('display','inline');
	$(".checkout_timer").html(checkout_timer(resend_checkout_timer)+" sec");
	var counter = resend_checkout_timer;
	 interval = setInterval(function() {
		counter--;
		 var places = (counter < 10 ? "0" : "");
		$(".checkout_timer").html(checkout_timer(counter)+" sec");
		if (counter == 0) {
			$(".checkout_timer").css('display','none');
			var cssString = "pointer-events: auto; cursor: pointer; opacity: 1;"; 
			$("#smsalert_checkout_resend_btn").attr('style',cssString);
			clearInterval(interval);
		}
		else
		{
			var cssString = "pointer-events: none; cursor: default; opacity: 1;";
			$("#smsalert_checkout_resend_btn").attr('style',cssString);
		}
	}, 1000);
}
jQuery(document).on("click", ".close",function(){
clearInterval(interval);
});
function verifyOTPForCheckout()
{
	
	$('.alert-dismissible, .text-danger').remove();
	var code = $('#smsalert_checkout_otp_code').val();
	if(code=='')
	{
		$('#SMSAlertCheckOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>{{blank_otp}}</strong></div>' );
		return false;
	}
	
	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=verify',
        type: 'post',
        data: {'code': code},
        dataType: 'json',
        success: function(json) {
			if(json['status']=='success' && json['description']['desc']=='Code Matched successfully.')
			{
				$('#SMSAlertCheckOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
				procceedCheckoutConfirm();
				$('#SMSAlertCheckOTPModal').modal('hide');
				
			}
			else
			{
				$('#SMSAlertCheckOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function sendOTPForCheckout()
{
	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=checkout',
        type: 'post',
       dataType: 'json',
        success: function(json) {
		    $('#SMSAlertCheckOTPModal').modal('show');
			$('.alert-dismissible, .text-danger').remove();
			if(json['status']=='success')
			{
				$('#SMSAlertCheckOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>Success! OTP sent Successfully to '+json['telephone']+'</strong> .</div>' );
				checkout_timerCount();
			}
			else
			{
				$('#SMSAlertCheckOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>Error! OTP sent Failed</strong> .</div>' );
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
	
	
}


function procceedCheckoutConfirm()
{
	$.ajax({
		url: 'index.php?route=checkout/payment_method/save',
		type: 'post',
		data: $('#collapse-payment-method input[type=\'radio\']:checked, #collapse-payment-method input[type=\'checkbox\']:checked, #collapse-payment-method textarea'),
		dataType: 'json',
		beforeSend: function() {
			$('#button-payment-method').button('loading');
		},
		success: function(json) {
			$('.alert-dismissible, .text-danger').remove();
						
			if (json['redirect']) {
				location = json['redirect'];
			} else if (json['error']) {
				$('#button-payment-method').button('reset');
				
				if (json['error']['warning']) {
					$('#collapse-payment-method .panel-body').prepend('<div class="alert alert-danger alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
				}
			} else {
				$.ajax({
					url: 'index.php?route=checkout/confirm',
					dataType: 'html',
					complete: function() {
						$('#button-payment-method').button('reset');
					},
					success: function(html) {
						$('#collapse-checkout-confirm .panel-body').html(html);
						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('<a href="#collapse-checkout-confirm" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_confirm }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-checkout-confirm\']').trigger('click');
					},
					error: function(xhr, ajaxOptions, thrownError) {
						alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
					}
				});
			}
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
	
}
//--></script>
<div id="SMSAlertLoginOTPModal" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="false" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Verification OTP</h4>
      </div>
      <div class="modal-body">
	  <div class="form-group">
        <input type="text" name="smsalert_otp_code" placeholder="Enter OTP" id="smsalert_otp_code" class="form-control" autocomplete="off" style="max-width:none;" />
		</div>
		<input type="hidden" class="input-phone">
		<input type="hidden" id="emailid"><input type="hidden" id="store_id">
			<br/>
			<button type="button" class="btn btn-default smsalert_resend_btn">Resend</button>
			<span class="login_timer"></span>
			
			<input type="button" id="smsalert_otp_login_verify_button" value="Validate OTP" class="btn btn-primary pull-right" />
      </div>
    </div>

  </div>
</div>
<script type="text/javascript">
var interval;
	function param(name) {
	return (parent.location.search.split(name + '=')[1] || '').split('&')[0];
	}
$(window).on('load', function() {
$('input[type=radio][name=account]').on('change', function () {
setTimeout( function(){ 
    initialise_login_smsalert(); 
  }  , 50 );
var type = $('[name="account"]:checked').val();
if(type!='login')
{
   $('.login-form .form-group,.login-form #login-otp').addClass('hide');
}
else{
initialise_login_smsalert();
}
});
   $.ajax({
        url: 'index.php?route=checkout/login',
        dataType: 'html',
        success: function(html) {
          initialise_login_smsalert();
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });

$('#smsalert_otp_login_verify_button').unbind('click').bind('click', function()
	{
		verifyLoginOTP();
	});
	
	$('.smsalert_resend_btn').unbind('click').bind('click', function(){
		sendOTPForLogin();
		return false;
	});
	
});
function initialise_login_smsalert()
{
	var status = '{{login_with_otp}}';
	var otpstatus = '{{otp_for_login}}';
	if(otpstatus=='1')
	{
		$("#button-login,#account-login [type='submit'],#vendor-login [type='submit'],.login-form [type='submit']").addClass('hide');
		$("#button-login,#account-login [type='submit'],#vendor-login [type='submit'],.login-form [type='submit']").before('<input type="button" value="Login" class="btn btn-primary" onclick="senduserotp()" id="default-smsalert"  style="margin-right:5px;">');
	}
	else{
	  $("#button-login,#account-login [type='submit'],#vendor-login [type='submit'],.login-form [type='submit']").css('margin-right','5px');
	}
	if(status=='1')
	{
	var params = param('route');
	var back_param= 'account/login&popup=login';
	if(params=='account/login')
	{
	back_param= 'account/login';
	}
	else if(params=='checkout/checkout')
	{
	back_param= 'checkout/checkout';
	}
	else if(params=='vendor/lts_login')
	{
	back_param= 'vendor/lts_login';
	}
	$("#button-login,#account-login [type='submit'],#vendor-login [type='submit'],.login-form [type='submit']").after('<input type="button" value="Login With OTP" class="btn btn-primary" id="smsalert-login-btn" style="margin-right:5px;margin-top:5px;" />');
	var disable_form = '{{smsalert_disable_default_login}}';
	var back = '<a href="index.php?route='+back_param+'">Back</a>';
	if(disable_form=='1')
	{
	back='';
	}
	$('#smsalert-login-btn').click(function() {
	$('#SMSAlertLoginOTPModal').removeAttr('style');
	$("#collapse-checkout-option .form-group,#account-login .form-group,#vendor-login .form-group,.login-form .form-group,[type='submit'],#smsalert-login-btn,#default-smsalert").addClass('hide');
	var target = $('#smsalert-login-btn');
	if($('#smsalert-login-btn').closest('.buttons').length > 0)
	{
	target = $('#smsalert-login-btn').closest('.buttons');
	}
	target.before('<div class="form-group"><label class="control-label" for="input-phone">Mobile Number</label><input type="text" name="phone" value="" placeholder="Mobile Number" class="form-control input-mobile"></div><div class="form-group"><input type="button" value="Login With OTP" class="btn btn-primary" id="login-otp" onclick="sendotp()"> '+back+'</div>');
	});
	if(disable_form=='1')
	{
	$('#smsalert-login-btn').trigger('click');
	}
	}
}
function sendotp()
{
var mobile = $('.input-mobile').val();
if(mobile=='')
{
  $('#SMSAlertLoginOTPModal .modal-title').html( '<span class="alert alert-danger alert-dismissible"><strong>Enter a valid mobile number</strong></span>' );
  $('#SMSAlertLoginOTPModal .modal-body').addClass('hide');
  $('#SMSAlertLoginOTPModal').modal('show');
  return false;
}
		sendOTPForLogin();
			return false;
}

function senduserotp()
{
 var user = $('#input-email').val();
 var pwd = $('#input-password').val();
 if(user!='' && pwd!='')
 {
	sendOTPForLogin(user,pwd);	
 }
 else{
  user = $('#input-login-email').val();
  pwd = $('#input-login-password').val();
  if(user!='' && pwd!='' && typeof user!="undefined")
  {
	sendOTPForLogin(user,pwd);	
  }
  else{
	  $('#SMSAlertLoginOTPModal .modal-title').html( '<span class="alert alert-danger alert-dismissible"><strong>Username or password fields are required.</strong></span>' );
	  $('#SMSAlertLoginOTPModal .modal-body').addClass('hide');
	  $('#SMSAlertLoginOTPModal').modal('show');
  }
 }
			return false;
}

function login_timerCount()
{
    var resend_login_timer = '{{resend_timer}}';
	var login_timer = function(secs){
		var sec_num = parseInt(secs, 10);
		var hours   = Math.floor(sec_num / 3600) % 24;
		var minutes = Math.floor(sec_num / 60) % 60;
		var seconds = sec_num % 60;
		hours = hours < 10 ? "0" + hours : hours;
		minutes = minutes < 10 ? "0" + minutes : minutes;
		seconds = seconds < 10 ? "0" + seconds : seconds;
		return [hours,minutes,seconds].join(":")
	};
	$(".login_timer").css('display','inline');
	$(".login_timer").html(login_timer(resend_login_timer)+" sec");
	var counter = resend_login_timer;
	 interval = setInterval(function() {
	 	counter--;
		 var places = (counter < 10 ? "0" : "");
		$(".login_timer").html(login_timer(counter)+ " sec");
		if (counter == 0) {
		   $(".login_timer").css('display','none');
			var cssString = "pointer-events: auto; cursor: pointer; opacity: 1;"; 
			$(".smsalert_resend_btn").attr('style',cssString);
			clearInterval(interval);
		}
		else
		{
			var cssString = "pointer-events: none; cursor: default; opacity: 1;";
			$(".smsalert_resend_btn").attr('style',cssString);
			
		}
	}, 1000);
}
jQuery(document).on("click", ".close",function(){
clearInterval(interval);
});
function verifyLoginOTP()
{
	$('.alert-dismissible, .text-danger').remove();
	var code = $('#smsalert_otp_code').val();
	if(code=='')
	{
		$('#SMSAlertLoginOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>{{blank_otp}}</strong></div>' );
		return false;
	}
	var mobile = $('.input-phone').val();

	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=verify&phone='+mobile,
        type: 'post',
        data: {'code': code},
        dataType: 'json',
        success: function(json) {
			if(json['status']=='success' && json['description']['desc']=='Code Matched successfully.')
			{
				$('#SMSAlertLoginOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
				$('#SMSAlertLoginOTPModal').modal('hide');
				login();
			}
			else
			{
				$('#SMSAlertLoginOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}
function login()
{
    var emailid = $('#emailid').val();
	var store_id = $('#store_id').val();
	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=dologin&email='+emailid,
        type: 'get',
        success: function(json) {
		var params = param('route');
	    if(params=='checkout/checkout')
		{
		parent.window.location = 'index.php?route=checkout/checkout';
		}
		else if(params=='vendor/lts_login')
		{
		parent.window.location = 'index.php?route=vendor/lts_dashboard';
		}
		else{
		parent.window.location = 'index.php?route=account/account';
		}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function sendOTPForLogin(user='',pwd='')
{
var mobile = $('.input-mobile').val();
if(mobile=='' || typeof mobile=="undefined")
{
  mobile = $('.input-phone').val();
}
var params = param('route');
var vendor = 0;
if(params == 'vendor/lts_login')
{
vendor = 1;
}
var ajax_url = 'index.php?route=extension/module/smsalert&otp_event=login&phone='+mobile+'&vendor='+vendor;	    
if(user!='')
{
ajax_url = 'index.php?route=extension/module/smsalert&otp_event=login&user='+user+'&pwd='+pwd+'&vendor='+vendor;
}
	$.ajax({
        url: ajax_url,
        type: 'post',
       dataType: 'json',
        success: function(json) {
		$('#SMSAlertLoginOTPModal').modal('show');
			$('.alert-dismissible, .text-danger').remove();
			if(json['status']=='success')
			{
			    $('#SMSAlertLoginOTPModal .modal-body').removeClass('hide');
				$('#SMSAlertLoginOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>Success! OTP sent Successfully to '+json['telephone']+'</strong> .</div>' );
				$('#emailid').val(json['email']);
				$('#store_id').val(json['store_id']);
				$('.input-phone').val(json['telephone']);
				login_timerCount();
			}
			else
			{
				$('#SMSAlertLoginOTPModal .modal-title').html( '<div class="alert alert-danger alert-dismissible"><strong>'+json['error']+'</strong> .</div>' );
				$('#SMSAlertLoginOTPModal .modal-body').addClass('hide');
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
	
	
}
</script>
<div id="SMSAlertCheckoutOTPModal" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="false" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Verification OTP</h4>
      </div>
      <div class="modal-body">
	  <div class="form-group">
        <input type="text" name="smsalert_check_otp_code" placeholder="Enter OTP" id="smsalert_check_otp_code" class="form-control" autocomplete="off" style="max-width:none;" />
		</div>
			<br/>
			<button type="button" class="btn btn-default" id="smsalert_check_resend_btn">Resend</button>
			<span class="timer"></span>
			
			<input type="button" id="smsalert_otp_check_verify_button" value="Validate OTP" class="btn btn-primary pull-right" />
      </div>
    </div>

  </div>
</div>
<script type="text/javascript">
var interval;
$(window).on('load', function() {
initialise_smsalert();
$('#smsalert_otp_check_verify_button').unbind('click').bind('click', function()
	{
		verifyOTP();
	});
	
	$('#smsalert_check_resend_btn').unbind('click').bind('click', function(){
		sendOTP();
		return false;
	});	
$('input[type=radio][name=payment_method]').on('change', function () {
   initialise_smsalert();
});
});

function initialise_smsalert()
{
	var otpstatus = '{{otp_for_checkout}}';
	var pay_method = $('[name="payment_method"]:checked').val();
	var enable_pay_method = '{{enabled_payment_methods}}';
	if(enable_pay_method=='' || (enable_pay_method.split(',').length > 0 && enable_pay_method.split(',').indexOf(pay_method) > -1) && otpstatus=='1')
	{
	    $("#checkout-smsalert").remove();
		$("#quick-checkout-button-confirm").addClass('hide');
		$("#quick-checkout-button-confirm").before('<input type="button" value="{{checkout_btn_text}}" class="btn btn-primary" onclick="sendcheckotp()" id="checkout-smsalert">');
	}
	else{
	$("#quick-checkout-button-confirm").removeClass('hide');
	$("#checkout-smsalert").remove();
	}
}
function sendcheckotp()
{
var firstname = $('#input-firstname').val();
var lastname = $('#input-lastname').val();
var email = $('#input-email').val();
var mobile = $('#input-telephone').val();
var address = $('#input-payment-address-1').val();
var city = $('#input-payment-city').val();
var postcode = $('#input-payment-postcode').val();
var country = $('#input-payment-country').val();
var zone = $('#input-payment-zone').val();
var pwd = $('#input-password').val();
var conf_pwd = $('#input-confirm').val();
if(firstname!='' && lastname!='' && email!='' && mobile!='' && address!='' && postcode!='' && country!='' && zone!='' && typeof(pwd)=='undefined')
{
    sendOTP();
}
else if(pwd!='' && conf_pwd!='')
{
 if(pwd==conf_pwd)
 {
  sendOTP('1');
 }
 else{
 $('#SMSAlertCheckoutOTPModal .modal-title').html( '<div class="alert alert-danger alert-dismissible"><strong>Password and confirm password does not match.</strong></div>' );
  $('#SMSAlertCheckoutOTPModal .modal-body').addClass('hide');
  $('#SMSAlertCheckoutOTPModal').modal('show');
 }
}
else{
  $('#SMSAlertCheckoutOTPModal .modal-title').html( '<span class="alert alert-danger alert-dismissible"><strong>Please fill all required fields.</strong></span>' );
  $('#SMSAlertCheckoutOTPModal .modal-body').addClass('hide');
  $('#SMSAlertCheckoutOTPModal').modal('show');
}
return false;
}

function timerCount()
{
	var resend_timer = '{{resend_timer}}';
	var timer = function(secs){
		var sec_num = parseInt(secs, 10);
		var hours   = Math.floor(sec_num / 3600) % 24;
		var minutes = Math.floor(sec_num / 60) % 60;
		var seconds = sec_num % 60;
		hours = hours < 10 ? "0" + hours : hours;
		minutes = minutes < 10 ? "0" + minutes : minutes;
		seconds = seconds < 10 ? "0" + seconds : seconds;
		return [hours,minutes,seconds].join(":")
	};
	$(".timer").css('display','inline');
	$(".timer").html(timer(resend_timer)+" sec");
	var counter = resend_timer;
	 interval = setInterval(function() {
		counter--;
		 var places = (counter < 10 ? "0" : "");
		 $(".timer").html(timer(counter)+" sec");
		if (counter == 0) {
			$(".timer").css('display','none');
			var cssString = "pointer-events: auto; cursor: pointer; opacity: 1;"; 
			$("#smsalert_check_resend_btn").attr('style',cssString);
			clearInterval(interval);
		}
		else
		{
			var cssString = "pointer-events: none; cursor: default; opacity: 1;";
			$("#smsalert_check_resend_btn").attr('style',cssString);
		}
	}, 1000);
}
jQuery(document).on("click", ".close",function(){
clearInterval(interval);
});
function verifyOTP()
{
	$('.alert-dismissible, .text-danger').remove();
	var code = $('#smsalert_check_otp_code').val();
	if(code=='')
	{
		$('#SMSAlertCheckoutOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>{{blank_otp}}</strong></div>' );
		return false;
	}
	var mobile = $('#input-telephone').val();

	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=verify&phone='+mobile,
        type: 'post',
        data: {'code': code},
        dataType: 'json',
        success: function(json) {
			if(json['status']=='success' && json['description']['desc']=='Code Matched successfully.')
			{
				$('#SMSAlertCheckoutOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
				$('#SMSAlertCheckoutOTPModal').modal('hide');
				$("#quick-checkout-button-confirm").trigger('click');
			}
			else
			{
				$('#SMSAlertCheckoutOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function sendOTP(reg=0)
{
var mobile = $('#input-telephone').val();
var ajax_url = 'index.php?route=extension/module/smsalert&otp_event=checkout&phone='+mobile+'&register='+reg;
	$.ajax({
        url: ajax_url,
        type: 'post',
       dataType: 'json',
        success: function(json) {
		$('#SMSAlertCheckoutOTPModal').modal('show');
			$('.alert-dismissible, .text-danger').remove();
			if(json['status']=='success')
			{
			    $('#SMSAlertCheckoutOTPModal .modal-body').removeClass('hide');
				$('#SMSAlertCheckoutOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>Success! OTP sent Successfully to '+json['telephone']+'</strong> .</div>' );
				timerCount();
			}
			else
			{
				$('#SMSAlertCheckoutOTPModal .modal-title').html( '<div class="alert alert-danger alert-dismissible"><strong>'+json['error']+'</strong> .</div>' );
				$('#SMSAlertCheckoutOTPModal .modal-body').addClass('hide');
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });	
}
</script>
<div id="SMSAlertCheckRegOTPModal" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="false" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Verification OTP</h4>
      </div>
      <div class="modal-body">
	  <div class="form-group">
        <input type="text" name="smsalert_reg_otp_code" placeholder="Enter OTP" id="smsalert_reg_otp_code" class="form-control" autocomplete="off" />
		</div>
			<br/>
			<button type="button" class="btn btn-default" id="smsalert_reg_resend_btn">Resend</button>
			<span class="reg_timer"></span>
			
			<input type="button" id="smsalert_otp_reg_checkout_verify_button" value="Validate OTP" class="btn btn-primary pull-right" />
      </div>
    </div>

  </div>
</div>
<script type="text/javascript">
var interval;
$(document).ready(function() {
	$('#button-register').unbind('click').bind('click', function() {
		var temp = '{{otp_for_register}}';
		if(temp=='1')
		{
			$(document).undelegate( '#button-register', "click");
			sendotpregister();
			return false;
		}
		
		procceedRegisterConfirm();
		
	});
	function sendotpregister()
	{
	var firstname = $('#input-payment-firstname').val();
	var lastname = $('#input-payment-lastname').val();
	var email = $('#input-payment-email').val();
	var mobile = $('#input-payment-telephone').val();
	var password = $('#input-payment-password').val();
	var confirm = $('#input-payment-confirm').val();
	var agree = $('input[name="agree"]').is(':checked');
	if(firstname!='' && lastname!='' && email!='' && mobile!='' && password!='' && confirm!='' && agree)
	{
	  sendCheckOTPForRegister();
	}
	else{
	  $('#SMSAlertCheckRegOTPModal .modal-title').html( '<div class="alert alert-danger alert-dismissible"><strong>Please fill all required fields.</strong></div>' );
	  $('#SMSAlertCheckRegOTPModal .modal-body').addClass('hide');
	  $('#SMSAlertCheckRegOTPModal').modal('show');
	}
	return false;
	}
	
	$('#smsalert_otp_reg_checkout_verify_button').unbind('click').bind('click', function()
	{
		verifyRegisterOTP();
	});
	
	$('#smsalert_reg_resend_btn').unbind('click').bind('click', function(){
		sendCheckOTPForRegister();
		return false;
	});
});



function reg_timerCount()
{
	var resend_timer = '{{resend_timer}}';
	var timer = function(secs){
		var sec_num = parseInt(secs, 10);
		var hours   = Math.floor(sec_num / 3600) % 24;
		var minutes = Math.floor(sec_num / 60) % 60;
		var seconds = sec_num % 60;
		hours = hours < 10 ? "0" + hours : hours;
		minutes = minutes < 10 ? "0" + minutes : minutes;
		seconds = seconds < 10 ? "0" + seconds : seconds;
		return [hours,minutes,seconds].join(":")
	};
	$(".reg_timer").css('display','inline');
	$(".reg_timer").html(timer(resend_timer)+" sec");
	var counter = resend_timer;
	 interval = setInterval(function() {
		counter--;
		 var places = (counter < 10 ? "0" : "");
		 $(".reg_timer").html(timer(counter)+" sec");
		if (counter == 0) {
			$(".reg_timer").css('display','none');
			var cssString = "pointer-events: auto; cursor: pointer; opacity: 1;"; 
			$("#smsalert_otp_reg_checkout_verify_button").attr('style',cssString);
			clearInterval(interval);
		}
		else
		{
			var cssString = "pointer-events: none; cursor: default; opacity: 1;";
			$("#smsalert_otp_reg_checkout_verify_button").attr('style',cssString);
		}
	}, 1000);
}
jQuery(document).on("click", ".close",function(){
clearInterval(interval);
});
function verifyRegisterOTP()
{
	
	$('.alert-dismissible, .text-danger').remove();
	var code = $('#smsalert_reg_otp_code').val();
	if(code=='')
	{
		$('#SMSAlertCheckRegOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>{{blank_otp}}</strong></div>' );
		return false;
	}
	var mobile = $('#input-payment-telephone').val();

	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=verify&phone='+mobile,
        type: 'post',
        data: {'code': code},
        dataType: 'json',
        success: function(json) {
			if(json['status']=='success' && json['description']['desc']=='Code Matched successfully.')
			{
				$('#SMSAlertCheckRegOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
				procceedRegisterConfirm();
				$('#SMSAlertCheckRegOTPModal').modal('hide');
				
			}
			else
			{
				$('#SMSAlertCheckRegOTPModal .modal-body').prepend( '<div class="alert alert-danger alert-dismissible"><strong>'+json['description']['desc']+'</strong></div>' );
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}


function sendCheckOTPForRegister()
{
var mobile = $('#input-payment-telephone').val();
	$.ajax({
        url: 'index.php?route=extension/module/smsalert&otp_event=register&phone='+mobile,
        type: 'post',
       dataType: 'json',
        success: function(json) {
		$('#SMSAlertCheckRegOTPModal').modal('show');
			
			$('.alert-dismissible, .text-danger').remove();
			if(json['status']=='success')
			{
				$('#SMSAlertCheckRegOTPModal .modal-body').removeClass('hide');
				$('#SMSAlertCheckRegOTPModal .modal-body').prepend( '<div class="alert alert-success alert-dismissible"><strong>Success! OTP sent Successfully to '+json['telephone']+'</strong> .</div>' );
				reg_timerCount();
			}
			else
			{
				$('#SMSAlertCheckRegOTPModal .modal-title').html( '<div class="alert alert-danger alert-dismissible"><strong>'+json['error']+'</strong> .</div>' );
				$('#SMSAlertCheckRegOTPModal .modal-body').addClass('hide');
			}
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
	
	
}


function procceedRegisterConfirm()
{
       $.ajax({
        url: 'index.php?route=checkout/register/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'password\'], #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
			$('#button-register').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
            $('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-register').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                                var shipping_address = $('#payment-address input[name=\'shipping_address\']:checked').prop('value');

                if (shipping_address) {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_method',
                        dataType: 'html',
                        success: function(html) {
							// Add the shipping address
                            $.ajax({
                                url: 'index.php?route=checkout/shipping_address',
                                dataType: 'html',
                                success: function(html) {
                                    $('#collapse-shipping-address .panel-body').html(html);

									$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">Step 3: Delivery Details <i class="fa fa-caret-down"></i></a>');
                                },
                                error: function(xhr, ajaxOptions, thrownError) {
                                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                }
                            });

							$('#collapse-shipping-method .panel-body').html(html);

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">Step 4: Delivery Method <i class="fa fa-caret-down"></i></a>');

   							$('a[href=\'#collapse-shipping-method\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('Step 4: Delivery Method');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('Step 5: Payment Method');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('Step 6: Confirm Order');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                } else {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_address',
                        dataType: 'html',
                        success: function(html) {
                            $('#collapse-shipping-address .panel-body').html(html);

							$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">Step 3: Delivery Details <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-address\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('Step 4: Delivery Method');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('Step 5: Payment Method');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('Step 6: Confirm Order');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                }
                
                $.ajax({
                    url: 'index.php?route=checkout/payment_address',
                    dataType: 'html',
                    complete: function() {
                        $('#button-register').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-payment-address .panel-body').html(html);

						$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">Step 2: Billing Details <i class="fa fa-caret-down"></i></a>');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}
</script>
       
<div id="checkout-checkout" class="container">
  <ul class="breadcrumb">
    {% for breadcrumb in breadcrumbs %}
    <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
    {% endfor %}
  </ul>
  {% if error_warning %}
  <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
    <button type="button" class="close" data-dismiss="alert">&times;</button>
  </div>
  {% endif %}
  <div class="row">{{ column_left }}
    {% if column_left and column_right %}
    {% set class = 'col-sm-6' %}
    {% elseif column_left or column_right %}
    {% set class = 'col-sm-9' %}
    {% else %}
    {% set class = 'col-sm-12' %}
    {% endif %}
    <div id="content" class="{{ class }}">{{ content_top }}
      <h1>{{ heading_title }}</h1>
      <div class="panel-group" id="accordion">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_option }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-checkout-option">
            <div class="panel-body"></div>
          </div>
        </div>
        {% if not logged and account != 'guest' %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_account }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-payment-address">
            <div class="panel-body"></div>
          </div>
        </div>
        {% else %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_payment_address }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-payment-address">
            <div class="panel-body"></div>
          </div>
        </div>
        {% endif %}
        {% if shipping_required %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_shipping_address }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-shipping-address">
            <div class="panel-body"></div>
          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_shipping_method }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-shipping-method">
            <div class="panel-body"></div>
          </div>
        </div>
        {% endif %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_payment_method }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-payment-method">
            <div class="panel-body"></div>
          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">{{ text_checkout_confirm }}</h4>
          </div>
          <div class="panel-collapse collapse" id="collapse-checkout-confirm">
            <div class="panel-body"></div>
          </div>
        </div>
      </div>
      {{ content_bottom }}</div>
    {{ column_right }}</div>
</div>
<script type="text/javascript"><!--
$(document).on('change', 'input[name=\'account\']', function() {
	if ($('#collapse-payment-address').parent().find('.panel-heading .panel-title > *').is('a')) {
		if (this.value == 'register') {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_account }} <i class="fa fa-caret-down"></i></a>');
		} else {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');
		}
	} else {
		if (this.value == 'register') {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('{{ text_checkout_account }}');
		} else {
			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_address }}');
		}
	}
});

{% if not logged %}
$(document).ready(function() {
    $.ajax({
        url: 'index.php?route=checkout/login',
        dataType: 'html',
        success: function(html) {
           $('#collapse-checkout-option .panel-body').html(html);

			$('#collapse-checkout-option').parent().find('.panel-heading .panel-title').html('<a href="#collapse-checkout-option" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_option }} <i class="fa fa-caret-down"></i></a>');

			$('a[href=\'#collapse-checkout-option\']').trigger('click');
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});
{% else %}
$(document).ready(function() {
    $.ajax({
        url: 'index.php?route=checkout/payment_address',
        dataType: 'html',
        success: function(html) {
            $('#collapse-payment-address .panel-body').html(html);

			$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');

			$('a[href=\'#collapse-payment-address\']').trigger('click');
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});
{% endif %}

// Checkout
$(document).delegate('#button-account', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/' + $('input[name=\'account\']:checked').val(),
        dataType: 'html',
        beforeSend: function() {
        	$('#button-account').button('loading');
		},
        complete: function() {
			$('#button-account').button('reset');
        },
        success: function(html) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            $('#collapse-payment-address .panel-body').html(html);

			if ($('input[name=\'account\']:checked').val() == 'register') {
				$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_account }} <i class="fa fa-caret-down"></i></a>');
			} else {
				$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');
			}

			$('a[href=\'#collapse-payment-address\']').trigger('click');
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Login
$(document).delegate('#button-login', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/login/save',
        type: 'post',
        data: $('#collapse-checkout-option :input'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-login').button('loading');
		},
        complete: function() {
            $('#button-login').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
            $('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#collapse-checkout-option .panel-body').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');

				// Highlight any found errors
				$('input[name=\'email\']').parent().addClass('has-error');
				$('input[name=\'password\']').parent().addClass('has-error');
		   }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Register
$(document).delegate('#button-register', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/register/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'password\'], #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
			$('#button-register').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
            $('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-register').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                {% if shipping_required %}
                var shipping_address = $('#payment-address input[name=\'shipping_address\']:checked').prop('value');

                if (shipping_address) {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_method',
                        dataType: 'html',
                        success: function(html) {
							// Add the shipping address
                            $.ajax({
                                url: 'index.php?route=checkout/shipping_address',
                                dataType: 'html',
                                success: function(html) {
                                    $('#collapse-shipping-address .panel-body').html(html);

									$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');
                                },
                                error: function(xhr, ajaxOptions, thrownError) {
                                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                }
                            });

							$('#collapse-shipping-method .panel-body').html(html);

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i></a>');

   							$('a[href=\'#collapse-shipping-method\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                } else {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_address',
                        dataType: 'html',
                        success: function(html) {
                            $('#collapse-shipping-address .panel-body').html(html);

							$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-address\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                }
                {% else %}
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
                {% endif %}

                $.ajax({
                    url: 'index.php?route=checkout/payment_address',
                    dataType: 'html',
                    complete: function() {
                        $('#button-register').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-payment-address .panel-body').html(html);

						$('#collapse-payment-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_address }} <i class="fa fa-caret-down"></i></a>');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Payment Address
$(document).delegate('#button-payment-address', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/payment_address/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'password\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-payment-address').button('loading');
		},
        complete: function() {
			$('#button-payment-address').button('reset');
        },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-warning alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().parent().addClass('has-error');
            } else {
                {% if shipping_required %}
                $.ajax({
                    url: 'index.php?route=checkout/shipping_address',
                    dataType: 'html',
                    success: function(html) {
                        $('#collapse-shipping-address .panel-body').html(html);

						$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-shipping-address\']').trigger('click');

						$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                }).done(function() {
					$.ajax({
						url: 'index.php?route=checkout/payment_address',
						dataType: 'html',
						success: function(html) {
							$('#collapse-payment-address .panel-body').html(html);
						},
						error: function(xhr, ajaxOptions, thrownError) {
							alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});
				});
                {% else %}
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                }).done(function() {
					$.ajax({
						url: 'index.php?route=checkout/payment_address',
						dataType: 'html',
						success: function(html) {
							$('#collapse-payment-address .panel-body').html(html);
						},
						error: function(xhr, ajaxOptions, thrownError) {
							alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});				
				});
                {% endif %}
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Shipping Address
$(document).delegate('#button-shipping-address', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/shipping_address/save',
        type: 'post',
        data: $('#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'date\'], #collapse-shipping-address input[type=\'datetime-local\'], #collapse-shipping-address input[type=\'time\'], #collapse-shipping-address input[type=\'password\'], #collapse-shipping-address input[type=\'checkbox\']:checked, #collapse-shipping-address input[type=\'radio\']:checked, #collapse-shipping-address textarea, #collapse-shipping-address select'),
        dataType: 'json',
        beforeSend: function() {
			$('#button-shipping-address').button('loading');
	    },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-shipping-address').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-shipping-address .panel-body').prepend('<div class="alert alert-warning alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-shipping-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().parent().addClass('has-error');
            } else {
                $.ajax({
                    url: 'index.php?route=checkout/shipping_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-shipping-address').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-shipping-method .panel-body').html(html);

						$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-shipping-method\']').trigger('click');

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
						
                        $.ajax({
                            url: 'index.php?route=checkout/shipping_address',
                            dataType: 'html',
                            success: function(html) {
                                $('#collapse-shipping-address .panel-body').html(html);
                            },
                            error: function(xhr, ajaxOptions, thrownError) {
                                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                            }
                        });
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                }).done(function() {
					$.ajax({
						url: 'index.php?route=checkout/payment_address',
						dataType: 'html',
						success: function(html) {
							$('#collapse-payment-address .panel-body').html(html);
						},
						error: function(xhr, ajaxOptions, thrownError) {
							alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
						}
					});
				});
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Guest
$(document).delegate('#button-guest', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/guest/save',
        type: 'post',
        data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address textarea, #collapse-payment-address select'),
        dataType: 'json',
        beforeSend: function() {
       		$('#button-guest').button('loading');
	    },
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-guest').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-payment-address .panel-body').prepend('<div class="alert alert-warning alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-payment-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                {% if shipping_required %}
                var shipping_address = $('#collapse-payment-address input[name=\'shipping_address\']:checked').prop('value');

                if (shipping_address) {
                    $.ajax({
                        url: 'index.php?route=checkout/shipping_method',
                        dataType: 'html',
                        complete: function() {
                            $('#button-guest').button('reset');
                        },
                        success: function(html) {
							// Add the shipping address
                            $.ajax({
                                url: 'index.php?route=checkout/guest_shipping',
                                dataType: 'html',
                                success: function(html) {
                                    $('#collapse-shipping-address .panel-body').html(html);

									$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');
                                },
                                error: function(xhr, ajaxOptions, thrownError) {
                                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                                }
                            });

						    $('#collapse-shipping-method .panel-body').html(html);

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-method\']').trigger('click');

							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                } else {
                    $.ajax({
                        url: 'index.php?route=checkout/guest_shipping',
                        dataType: 'html',
                        complete: function() {
                            $('#button-guest').button('reset');
                        },
                        success: function(html) {
                            $('#collapse-shipping-address .panel-body').html(html);

							$('#collapse-shipping-address').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-address" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_address }} <i class="fa fa-caret-down"></i></a>');

							$('a[href=\'#collapse-shipping-address\']').trigger('click');

							$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_shipping_method }}');
							$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
							$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                        }
                    });
                }
                {% else %}
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-guest').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
                {% endif %}
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Guest Shipping
$(document).delegate('#button-guest-shipping', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/guest_shipping/save',
        type: 'post',
        data: $('#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'date\'], #collapse-shipping-address input[type=\'datetime-local\'], #collapse-shipping-address input[type=\'time\'], #collapse-shipping-address input[type=\'password\'], #collapse-shipping-address input[type=\'checkbox\']:checked, #collapse-shipping-address input[type=\'radio\']:checked, #collapse-shipping-address textarea, #collapse-shipping-address select'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-guest-shipping').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-guest-shipping').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-shipping-address .panel-body').prepend('<div class="alert alert-danger alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }

				for (i in json['error']) {
					var element = $('#input-shipping-' + i.replace('_', '-'));

					if ($(element).parent().hasClass('input-group')) {
						$(element).parent().after('<div class="text-danger">' + json['error'][i] + '</div>');
					} else {
						$(element).after('<div class="text-danger">' + json['error'][i] + '</div>');
					}
				}

				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            } else {
                $.ajax({
                    url: 'index.php?route=checkout/shipping_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-guest-shipping').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-shipping-method .panel-body').html(html);

						$('#collapse-shipping-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-shipping-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_shipping_method }} <i class="fa fa-caret-down"></i>');

						$('a[href=\'#collapse-shipping-method\']').trigger('click');

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('{{ text_checkout_payment_method }}');
						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

$(document).delegate('#button-shipping-method', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/shipping_method/save',
        type: 'post',
        data: $('#collapse-shipping-method input[type=\'radio\']:checked, #collapse-shipping-method textarea'),
        dataType: 'json',
        beforeSend: function() {
        	$('#button-shipping-method').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-shipping-method').button('reset');

                if (json['error']['warning']) {
                    $('#collapse-shipping-method .panel-body').prepend('<div class="alert alert-danger alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }
            } else {
                $.ajax({
                    url: 'index.php?route=checkout/payment_method',
                    dataType: 'html',
                    complete: function() {
                        $('#button-shipping-method').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-payment-method .panel-body').html(html);

						$('#collapse-payment-method').parent().find('.panel-heading .panel-title').html('<a href="#collapse-payment-method" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_payment_method }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-payment-method\']').trigger('click');

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('{{ text_checkout_confirm }}');
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

$(document).delegate('#button-payment-method', 'click', function() {
    $.ajax({
        url: 'index.php?route=checkout/payment_method/save',
        type: 'post',
        data: $('#collapse-payment-method input[type=\'radio\']:checked, #collapse-payment-method input[type=\'checkbox\']:checked, #collapse-payment-method textarea'),
        dataType: 'json',
        beforeSend: function() {
         	$('#button-payment-method').button('loading');
		},
        success: function(json) {
            $('.alert-dismissible, .text-danger').remove();

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                $('#button-payment-method').button('reset');
                
                if (json['error']['warning']) {
                    $('#collapse-payment-method .panel-body').prepend('<div class="alert alert-danger alert-dismissible">' + json['error']['warning'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                }
            } else {
                $.ajax({
                    url: 'index.php?route=checkout/confirm',
                    dataType: 'html',
                    complete: function() {
                        $('#button-payment-method').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-checkout-confirm .panel-body').html(html);

						$('#collapse-checkout-confirm').parent().find('.panel-heading .panel-title').html('<a href="#collapse-checkout-confirm" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_confirm }} <i class="fa fa-caret-down"></i></a>');

						$('a[href=\'#collapse-checkout-confirm\']').trigger('click');
					},
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});
//--></script>
{{ footer }}